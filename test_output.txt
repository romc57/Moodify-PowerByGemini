
> moodify-mobile@1.0.0 test
> jest tests/unit/services/RecommendationService.test.ts

  console.log
    [jest-env-setup] Loaded .env.test file

      at Object.<anonymous> (jest-env-setup.js:9:11)

  console.log
    [jest-env-setup] Found 5 environment variables in .env.test

      at Object.<anonymous> (jest-env-setup.js:11:11)

  console.log
    [SpotifyRemote] Initializing Service...

      at Function.log [as getInstance] (services/spotify/SpotifyRemoteService.ts:82:21)

  console.log
    [Gemini] Gemini 3 Pro: Available (2366ms)

      at GeminiService.log (services/gemini/GeminiService.ts:138:21)

  console.log
    [TestUtils] [Spotify] Checking session...

      at log (tests/utils/testDb.ts:199:13)

  console.log
    [TestUtils] ========================================

      at log (tests/utils/testDb.ts:204:13)

  console.warn
    [TestUtils] ⚠⚠⚠ Some sessions are not active ⚠⚠⚠

      207 |         console.log('[TestUtils] ✓✓✓ Tests will run with real API calls ✓✓✓');
      208 |     } else {
    > 209 |         console.warn('[TestUtils] ⚠⚠⚠ Some sessions are not active ⚠⚠⚠');
          |                 ^
      210 |         console.warn('[TestUtils] ⚠⚠⚠ Tests will be SKIPPED ⚠⚠⚠');
      211 |         if (!hasActiveGemini) {
      212 |             console.warn('[TestUtils] ⚠ Gemini session is NOT active');

      at warn (tests/utils/testDb.ts:209:17)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  console.warn
    [TestUtils] ⚠⚠⚠ Tests will be SKIPPED ⚠⚠⚠

      208 |     } else {
      209 |         console.warn('[TestUtils] ⚠⚠⚠ Some sessions are not active ⚠⚠⚠');
    > 210 |         console.warn('[TestUtils] ⚠⚠⚠ Tests will be SKIPPED ⚠⚠⚠');
          |                 ^
      211 |         if (!hasActiveGemini) {
      212 |             console.warn('[TestUtils] ⚠ Gemini session is NOT active');
      213 |         }

      at warn (tests/utils/testDb.ts:210:17)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  console.warn
    [TestUtils] ⚠ Spotify session is NOT active

      213 |         }
      214 |         if (!hasActiveSpotify) {
    > 215 |             console.warn('[TestUtils] ⚠ Spotify session is NOT active');
          |                     ^
      216 |         }
      217 |     }
      218 |     console.log('[TestUtils] ========================================');

      at warn (tests/utils/testDb.ts:215:21)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

  console.log
    [TestUtils] ========================================

      at log (tests/utils/testDb.ts:218:13)

  console.log


      at log (tests/utils/testDb.ts:219:13)

  console.warn
    [RecommendationService Integration] ⚠ Sessions inactive - tests will be skipped: [
      'Spotify: No active session (token expired, refresh failed or no refresh token)'
    ]

      131 |             sessionsActive = status.runGeminiAndSpotify;
      132 |             if (!sessionsActive) {
    > 133 |                 console.warn('[RecommendationService Integration] ⚠ Sessions inactive - tests will be skipped:', status.errors);
          |                         ^
      134 |             }
      135 |         }, 30000);
      136 |

      at Object.warn (tests/unit/services/RecommendationService.test.ts:133:25)
      at asyncGeneratorStep (node_modules/@babel/runtime/helpers/asyncToGenerator.js:3:17)
      at _next (node_modules/@babel/runtime/helpers/asyncToGenerator.js:17:9)

FAIL unit tests/unit/services/RecommendationService.test.ts (6.187 s)
  RecommendationService Unit Tests
    getVibeOptions
      ✕ should return validated options when Gemini returns suggestions (8 ms)
      ✕ should handle empty Gemini response gracefully (1 ms)
      ✕ should handle missing API keys gracefully (1 ms)
  RecommendationService Integration Tests
    getVibeOptions with real APIs
      ✓ should fetch real vibe options from Gemini and validate against Spotify (1 ms)
      ✓ should handle real API errors gracefully (2 ms)

  ● RecommendationService Unit Tests › getVibeOptions › should return validated options when Gemini returns suggestions

    ReferenceError: graphService is not defined

      64 |         (dbService.getRecentHistory as jest.Mock).mockResolvedValue([]);
      65 |         (dbService.getDailyHistoryURIs as jest.Mock).mockResolvedValue([]);
    > 66 |         (graphService.getClusterRepresentatives as jest.Mock).mockResolvedValue([]);
         |          ^
      67 |         (graphService.getEffectiveNode as jest.Mock).mockResolvedValue(null);
      68 |         (graphService.getNeighbors as jest.Mock).mockResolvedValue([]);
      69 |     });

      at Object.graphService (tests/unit/services/RecommendationService.test.ts:66:10)

  ● RecommendationService Unit Tests › getVibeOptions › should handle empty Gemini response gracefully

    ReferenceError: graphService is not defined

      64 |         (dbService.getRecentHistory as jest.Mock).mockResolvedValue([]);
      65 |         (dbService.getDailyHistoryURIs as jest.Mock).mockResolvedValue([]);
    > 66 |         (graphService.getClusterRepresentatives as jest.Mock).mockResolvedValue([]);
         |          ^
      67 |         (graphService.getEffectiveNode as jest.Mock).mockResolvedValue(null);
      68 |         (graphService.getNeighbors as jest.Mock).mockResolvedValue([]);
      69 |     });

      at Object.graphService (tests/unit/services/RecommendationService.test.ts:66:10)

  ● RecommendationService Unit Tests › getVibeOptions › should handle missing API keys gracefully

    ReferenceError: graphService is not defined

      64 |         (dbService.getRecentHistory as jest.Mock).mockResolvedValue([]);
      65 |         (dbService.getDailyHistoryURIs as jest.Mock).mockResolvedValue([]);
    > 66 |         (graphService.getClusterRepresentatives as jest.Mock).mockResolvedValue([]);
         |          ^
      67 |         (graphService.getEffectiveNode as jest.Mock).mockResolvedValue(null);
      68 |         (graphService.getNeighbors as jest.Mock).mockResolvedValue([]);
      69 |     });

      at Object.graphService (tests/unit/services/RecommendationService.test.ts:66:10)


========== FAILED TESTS SUMMARY ==========
Total: 3 failed test(s) in 1 suite(s). Full error and stack below.

Suite: tests/unit/services/RecommendationService.test.ts
  ✗ RecommendationService Unit Tests getVibeOptions should return validated options when Gemini returns suggestions
    ReferenceError: graphService is not defined
        at Object.graphService (/home/rom/Projects/Moodify-PowerByGemini/tests/unit/services/RecommendationService.test.ts:66:10)
        at Promise.then.completed (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/utils.js:298:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/utils.js:231:10)
        at _callCircusHook (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:281:40)
        at _runTest (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:246:5)
        at _runTestsForDescribeBlock (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:126:9)
        at _runTestsForDescribeBlock (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:121:9)
        at _runTestsForDescribeBlock (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:121:9)
        at run (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:71:3)
        at runAndTransformResultsToJestFormat (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
        at jestAdapter (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
        at runTestInternal (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-runner/build/runTest.js:367:16)
        at runTest (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-runner/build/runTest.js:444:34)

  ✗ RecommendationService Unit Tests getVibeOptions should handle empty Gemini response gracefully
    ReferenceError: graphService is not defined
        at Object.graphService (/home/rom/Projects/Moodify-PowerByGemini/tests/unit/services/RecommendationService.test.ts:66:10)
        at Promise.then.completed (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/utils.js:298:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/utils.js:231:10)
        at _callCircusHook (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:281:40)
        at _runTest (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:246:5)
        at _runTestsForDescribeBlock (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:126:9)
        at _runTestsForDescribeBlock (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:121:9)
        at _runTestsForDescribeBlock (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:121:9)
        at run (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:71:3)
        at runAndTransformResultsToJestFormat (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
        at jestAdapter (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
        at runTestInternal (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-runner/build/runTest.js:367:16)
        at runTest (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-runner/build/runTest.js:444:34)

  ✗ RecommendationService Unit Tests getVibeOptions should handle missing API keys gracefully
    ReferenceError: graphService is not defined
        at Object.graphService (/home/rom/Projects/Moodify-PowerByGemini/tests/unit/services/RecommendationService.test.ts:66:10)
        at Promise.then.completed (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/utils.js:298:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/utils.js:231:10)
        at _callCircusHook (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:281:40)
        at _runTest (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:246:5)
        at _runTestsForDescribeBlock (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:126:9)
        at _runTestsForDescribeBlock (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:121:9)
        at _runTestsForDescribeBlock (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:121:9)
        at run (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/run.js:71:3)
        at runAndTransformResultsToJestFormat (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapterInit.js:122:21)
        at jestAdapter (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-circus/build/legacy-code-todo-rewrite/jestAdapter.js:79:19)
        at runTestInternal (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-runner/build/runTest.js:367:16)
        at runTest (/home/rom/Projects/Moodify-PowerByGemini/node_modules/jest-runner/build/runTest.js:444:34)

======================================

Test Suites: 1 failed, 1 total
Tests:       3 failed, 2 passed, 5 total
Snapshots:   0 total
Time:        6.905 s
Ran all test suites matching /tests\/unit\/services\/RecommendationService.test.ts/i.
